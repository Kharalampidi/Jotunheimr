box: starefossen/iojs-imagemagick
build:
    steps:
        - npm-install

        - script:
                name: npm run-script test-drone
                code: |
                    npm run-script test-drone

        - script:
                name: echo nodejs information
                code: |
                    echo "node version $(node -v) running"
                    echo "npm version $(npm -v) running"

    after-steps:
        - turistforeningen/slack-notifier:
                url: $SLACK_WEBHOOK_URL

deploy:
    steps:
        - add-to-known_hosts:
                hostname: $SSH_HOST
        - mktemp:
                envvar: PRIVATEKEY_PATH
        - create-file:
                name: write key
                filename: $PRIVATEKEY_PATH
                content: $SSH_KEY_PRIVATE
                overwrite: true
                hide-from-log: true
        - script:
                name: start application
                code: |
                    ssh -i ${PRIVATEKEY_PATH} \
                        -o UserKnownHostsFile=/dev/null \
                        -o StrictHostKeyChecking=no \
                        -l ${SSH_USER} \
                        ${SSH_HOST} \
                        COMPOSE_FILE=docker-paas.yml /var/www/config/manage.sh ${SSH_APP} update

    after-steps:
        - turistforeningen/slack-notifier:
                url: $SLACK_WEBHOOK_URL
